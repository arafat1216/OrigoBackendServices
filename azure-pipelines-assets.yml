# Build and Deploy to Azure Kubernetes Service using templates

trigger:
  branches:
    include:
    - trunk
  paths:
    include:
    - azure-pipelines-assets.yml
    - charts/asset-api
    - src/Core
    - src/Services/Asset

resources:
- repo: self

variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: '09ee8083-2a55-4731-876c-d6df7059bd8f'
  artifactsFeedSource: 'https://pkgs.dev.azure.com/mytos/OrigoV2/_packaging/Origo2/nuget/v3/index.json'
  imageRepository: 'assetsbackend'
  containerRegistry: 'origov2acr.azurecr.io'

stages:
- stage: Build
  displayName: Build stage
  jobs:
  - template: general-build.yaml
    parameters:
      vmImage: 'ubuntu-latest'
      dbContext: 'AssetsContext'
      dbProject: 'src/Services/Asset/AssetServices/AssetServices.csproj'
      migrationScriptOutputDir: '$(build.artifactstagingdirectory)/migrations'
      buildRepositoryLocalPath: '$(Build.Repository.LocalPath)'
      imageRepository: '$(imageRepository)'
      dockerfilePath: 'src/Services/Asset/Asset.API/Dockerfile'
      dockerRegistryServiceConnection: '09ee8083-2a55-4731-876c-d6df7059bd8f'
      buildId: '$(Build.BuildId)'
      sonarToken: '$(SonarToken)'
      artifactsFeedSource: 'https://pkgs.dev.azure.com/mytos/OrigoV2/_packaging/Origo2/nuget/v3/index.json'
      buildSourcesDirectory: $(Build.SourcesDirectory)
      buildSourceBranchName: $(Build.SourceBranchName)
      chartName: 'asset-api'


- stage: DeployDev
  displayName: Deploy to Dev
  condition: and(succeeded(), not(startsWith(variables['Build.SourceBranch'], 'refs/pull/')))
  dependsOn: Build
  variables:
  - group: AssetsLibrary
  jobs:
  - template: general-deploy.yaml
    parameters:
      vmImage: 'ubuntu-latest'
      environment: 'OrigoV2AKS_Dev.develop'
      artifactDirectory: $(System.ArtifactsDirectory)
      dbConnection: '$(AssetsDbConnection)'
      releaseName: assetservices
      namespace: develop
      tag: '$(Build.BuildId)'
      pipelineWorkspace: $(Pipeline.Workspace)

- stage: DeployTest
  displayName: Deploy to Test
  dependsOn: DeployDev
  variables:
  - group: AssetsLibrary
  jobs:
  - template: general-deploy.yaml
    parameters:
      vmImage: 'ubuntu-latest'
      environment: 'OrigoV2AKS.test'
      artifactDirectory: $(System.ArtifactsDirectory)
      dbConnection: '$(AssetsDbConnectionTest)'
      releaseName: assetservices
      namespace: test
      tag: '$(Build.BuildId)'
      pipelineWorkspace: $(Pipeline.Workspace)

- stage: DeployProd
  displayName: Deploy to Prod
  dependsOn: DeployTest
  variables:
  - group: AssetsLibrary
  jobs:
  - template: general-deploy.yaml
    parameters:
      vmImage: 'ubuntu-latest'
      environment: 'OrigoV2AKS.prod'
      artifactDirectory: $(System.ArtifactsDirectory)
      dbConnection: '$(AssetsDbConnectionProd)'
      releaseName: assetservices
      namespace: prod
      tag: '$(Build.BuildId)'
      pipelineWorkspace: $(Pipeline.Workspace)